gsub(" ", "", as.character(formula(y ~ x)))
formula(y ~ x)
formula(y ~ x + z)
gsub(" ", "", as.character(formula(y ~ x + z)))
formula(y ~ x)[2]
formula(y ~ x)[3]
formula(y ~ x + z)[3]
formula_sample <- formula(y ~ x + z + x:z)
formula_sample
gsub(" ", "", as.character(formula_sample[2]))
formula_sample[2]
formula_sample[3]
gsub(" ", "", as.character(reg_formula[3]))
gsub(" ", "", as.character(formula_sample[3]))
as.character(formula_sample[3])
gsub("+", "", as.character(formula_sample[3]))
gsub(" ", "+", as.character(formula_sample[3]))
gsub(" ", "", as.character(formula_sample[3]))
grep(gsub("+", as.character(formula_sample[3])))
grep("[a-z]", letters)
gsub("([ab])", "\\1_\\1_", "abc and ABC")
sub(".*:", "", c("G1:E001", "G2:E002", "G3:E003"))
sub("*:", "", c("G1:E001", "G2:E002", "G3:E003"))
sub(".*:", "", c("G1:E001", "G2:E002", "G3:E003"))
sub("+", "", gsub(" ", "", as.character(formula_sample[3])))
sub("+.", "", as.character(formula_sample[3])))
sub("+.", "", as.character(formula_sample[3]))
sub("+*", "", as.character(formula_sample[3]))
sub("+.*", "", as.character(formula_sample[3]))
sub(".+.*", "", as.character(formula_sample[3]))
sub("*+.", "", as.character(formula_sample[3]))
sub("?+.", "", as.character(formula_sample[3]))
substr("y", gregexpr(",", "y")[[1]][1]+1 ,  gregexpr(")", "y")[[1]][1]-1 )
substr("y_100", gregexpr(",", "y_100")[[1]][1]+1 ,  gregexpr(")", "y_100")[[1]][1]-1 )
gsub(" ", "", as.character(formula_sample[2]))
substr(outcome_char, 6, gregexpr(",", "y")[[1]][1] - 1  )
substr("y", 6, gregexpr(",", "y")[[1]][1] - 1  )
library(stringr)
str_extract("x+z+x:z", +*"")
str_extract("x+z+x:z", "+*")
str_extract("x+z+x:z", "\+*")
str_extract("x+z+x:z", "/+*")
str_extract("x+z+x:z", "*")
str_extract("x+z+x:z", "\\+")
str_extract("x+z+x:z", "\\+.")
str_extract("x+z+x:z", "\\+*")
str_extract("x+z+x:z", "\\d")
str_extract("x+z+x:z", "\\...")
str_extract("x+z+x:z", "\\..")
str_extract("x+z+x:z", "\\+..")
str_extract("x+z+x:z", "\\+")
str_extract("x+z+x:z", ".\\+")
str_extract("x+z+x:z", ".+\\+")
str_extract("x+z+x:z", "\\+?")
str_extract("x+z+x:z", "?\\+")
str_extract("x+z+x:z", "\\+")
str_extract("x+z+x:z", "*+\\+")
str_extract("x+z+x:z", "?+\\+")
str_extract("x+z+x:z", "\\+[]")
str_extract("x+z+x:z", "\\+(.)")
str_extract("x+z+x:z", "\\+[.]")
str_extract("x+z+x:z", "\\+\w")
str_extract("x+z+x:z", "\w")
str_extract("x+z+x:z", "w")
str_extract("x+z+x:z", "\\w")
str_extract("x+z+x:z", "\\w+")
str_extract("x+z+x:z", "\\w+\\w")
str_extract("x+z+x:z", "\\w+\\+")
str_extract("x+z+x:z", "\\w+\\+\\w")
str_extract_all("x+z+x:z", "\\w")
str_extract_all("x+z+x:z", "\\w\\+")
str_extract_all("x+z+x:z", "(\\w)\\+")
str_extract_all("x+z+x:z", "(\\w)")
str_extract_all("x+z+x:z", "\\w?\\+")
str_extract_all("x+z+x:z", "\\*?\\+")
str_extract_all("x+z+x:z", "\[letters]\\+")
str_extract_all("x+z+x:z", "[letters]?\\+")
str_extract_all("x+z+x:z", "?[letters]\\+")
str_extract_all("x+z+x:z", "\?[letters]\\+")
str_extract_all("x+z+x:z", "\\?[letters]\\+")
str_extract_all("x+z+x:z", "\\?[letters]")
str_extract_all("x+z+x:z", "\\?\\+")
str_extract_all("x+z+x:z", "\\?+\\+")
paste0(c("1,2,3"), collapse = ",")
strsplit("x+z+x:z", "[\+]+")
strsplit("x+z+x:z", "[\\+]+")
hist(rbeta(1000, 2, 2))
hist(rbeta(10000, 2, 2))
formula_sample
gsub(" ", "", as.character(formula_sample[2]))
substr("y", 6, gregexpr(",", "y")[[1]][1] - 1  )
outcome_char = gsub(" ", "", as.character(formula_sample[2]))
y_name =substr(outcome_char, 6, gregexpr(",", outcome_char)[[1]][1] - 1  )
y_name
delta_name = substr(outcome_char, gregexpr(",", outcome_char)[[1]][1]+1 ,  gregexpr(")", outcome_char)[[1]][1]-1 )
delta_name
formula_sample
formula_sample = y ~ x*z
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ age + ph.ecog + sex,
A = 'sex', num_intervals = 100, warmup = 1000, post_iter = 1000 )
reg_formula = Surv(time, status) ~ age + ph.ecog + sex
outcome_char = gsub(" ", "", as.character(reg_formula[2]))
outcome_char
y_name =substr(outcome_char, 6, gregexpr(",", outcome_char)[[1]][1] - 1  )
delta_name = substr(outcome_char, gregexpr(",", outcome_char)[[1]][1]+1 ,  gregexpr(")", outcome_char)[[1]][1]-1 )
y_name
delta_name
covar_char = gsub(" ", "", as.character(reg_formula[3]))
covar_char
# can use strsplit(covar_char, "[\\+]+")
covar_names = c('age', 'ph.ecog') ## need to get this from covar_char somehow.
covar_names
# can use strsplit(covar_char, "[\\+]+")
covar_names = c('age', 'ph.ecog', 'sex') ## need to get this from covar_char somehow.
strsplit(covar_char, "[\\+]+")
strsplit(covar_char, "[\\+]+")
strsplit(covar_char, "[\\+]+")
y_name
delta_name
hist(rbeta(1000, 4, 4))
hist(rbeta(1000, 1, 1))
gsub(" ", "", as.character(reg_formula[3]))
strsplit(covar_char, "[\\+]+")
strsplit(covar_char, "[\\+]+")[[1]]
bayeshaz = function(d, reg_formula, A, num_intervals=100, warmup=1000, post_iter=1000){
## user-specified intervention variable
trt_names = A
outcome_char = gsub(" ", "", as.character(reg_formula[2]))
### collect user inputs
y_name =substr(outcome_char, 6, gregexpr(",", outcome_char)[[1]][1] - 1  )
delta_name = substr(outcome_char, gregexpr(",", outcome_char)[[1]][1]+1 ,  gregexpr(")", outcome_char)[[1]][1]-1 )
covar_char = gsub(" ", "", as.character(reg_formula[3]))
# can use strsplit(covar_char, "[\\+]+")
# covar_names = c('age', 'ph.ecog', 'sex') ## need to get this from covar_char somehow.
covar_names = strsplit(covar_char, "[\\+]+")[[1]]
y = d[, y_name]
delta = d[,delta_name]
## partition time interval
partition = seq(0, max(y)+.01,length.out=num_intervals)
#outcome = paste0("Surv(", y_name,", ", delta_name,") ~ ")
#reg_formula = as.formula(paste0(outcome, paste0(covar_names, collapse = "+"), "+", paste0(trt_names, collapse = "+") ) )
## create long-form data set
dsplit = survival::survSplit(data = d, formula = reg_formula, cut = partition, id='id')
dsplit$offset = dsplit[,y_name] - dsplit$tstart ## amount of survival time in each interval
dsplit$interval = as.factor(dsplit$tstart) ## factor interval
dsplit$interval_num = as.numeric(as.factor(dsplit$tstart)) ## interval number
## create covariate model matrix
xmat = model.matrix(data=dsplit, object = as.formula(paste0(" ~ -1 + ", covar_char  )) )
## create list of data to pass to Stan model
dlist = list(N=nrow(dsplit),
P = ncol(xmat),
n_pieces = length( unique(dsplit$interval_num) ),
delta = dsplit[, delta_name],
offset  = dsplit$offset,
interval_num = dsplit$interval_num,
xmat = xmat)
mod = cmdstan_model("hazard_mod.stan")
res = mod$sample(data= dlist,
chains = 1,  iter_warmup = warmup, iter_sampling = post_iter)
haz_draws = exp(res$draws("log_haz", format = 'matrix') )
beta_draws = res$draws("beta", format = 'matrix')
xv = (partition[-1] - .5*mean(diff(partition)) ) ## midpoint of each interval
draws = list(haz_draws = haz_draws, beta_draws=beta_draws,
xv = xv, partition = partition )
return(draws)
}
library(survival)
library(cmdstanr)
install.packages("cmdstanr")
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan()
d = survival::cancer
d = d[complete.cases(d),] ## drop missing data
d$id = 1:nrow(d) ## patient id
d$status[d$status==2] = 0
## recode binary variables to 0/1
d$sex[d$sex==2] = 0
d$age = ( d$age - mean(d$age) )/ sd(d$age) ## standardize age
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ age + ph.ecog + sex,
A = 'sex', num_intervals = 100, warmup = 1000, post_iter = 1000 )
## posterior mean/ 95% interval
bslhaz_mean = colMeans(post_draws$haz_draws)
bslhaz_lwr = apply(post_draws$haz_draws, 2, quantile, probs=.025)
bslhaz_upr = apply(post_draws$haz_draws, 2, quantile, probs=.975)
bslhaz_mean
View(post_draws)
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
## estimate frequentist piecewise exponential hazard function
freq_res = eha::pchreg(data=d,cuts = seq( 0 , max(d$time) + .01, length.out = 100 ),
formula = Surv(time, status) ~  age + ph.ecog + sex)
View(freq_res)
## overlay frequentist point estimates
points(post_draws$xv, freq_res$hazards, col='red')
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col='red'ï¼Œpch = 19)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col='red', pch = 19)
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col='red', pch = 19, cex = 0.1)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col='red', pch = 19, cex = 0.5)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col=rgb(1,0,0,0.7), pch = 19, cex = 0.5)
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col=rgb(1,0,0,0.7), pch = 19, cex = 0.5)
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col=rgb(1,0,0,0.5), pch = 19, cex = 0.5)
# plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .08) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
# plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .05) )
plot( post_draws$xv, bslhaz_mean, pch=20, ylim=c(0, .1) )
segments(x0 = post_draws$xv, y0 = bslhaz_lwr,
x1 = post_draws$xv, y1 = bslhaz_upr)
## overlay frequentist point estimates
# points(post_draws$xv, freq_res$hazards, col='red')
points(post_draws$xv, freq_res$hazards, col=rgb(1,0,0,0.5), pch = 19, cex = 0.5)
## compare coefficients with frequentist estimates
colMeans(post_draws$beta_draws)
apply(post_draws$beta_draws, 2, quantile, probs=c(.025, .975))
freq_res$coefficients
apply(post_draws$beta_draws, 2, quantile, probs=0.5ï¼‰
apply(post_draws$beta_draws, 2, quantile, probs=0.5)
apply(post_draws$beta_draws, 2, mean)
View(d)
?survival::cancer
tmp <- installed.packages()
installedpkgs <- as.vector(tmp[is.na(tmp[,"Priority"]), 1])
save(installedpkgs, file="installed_old.rda")
installedpkgs
R.Version()
R.Version()
tmp <- installed.packages()
installedpkgs.new <- as.vector(tmp[is.na(tmp[,"Priority"]), 1])
missing <- setdiff(installedpkgs, installedpkgs.new)
install.packages(missing)
update.packages()
y
chooseBioCmirror()
chooseBioCmirror()
biocLite()
load("installed_old.rda")
tmp <- installed.packages()
installedpkgs.new <- as.vector(tmp[is.na(tmp[,"Priority"]), 1])
missing <- setdiff(installedpkgs, installedpkgs.new)
for (i in 1:length(missing)) biocLite(missing[i])
library(BiocManager)
library(BiocManager)
for (i in 1:length(missing)) biocLite(missing[i])
BiocManager::install("biocLite")
BiocManager::install(missing)
install.packages("cmdstanr")
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
BiocManager::install("biomaRt")
installedpkgs.new <- as.vector(tmp[is.na(tmp[,"Priority"]), 1])
missing <- setdiff(installedpkgs, installedpkgs.new)
missing
BiocManager::available()
BiocManager::available("biomaRt")
BiocManager::install("biomaRt")
library(biomaRt)
func_attempt <- function(x, func){
return(sapply(x, func))
}
x = list()
x[[1]] = 1:5
x[[2]] = 2:6
x[[3]] = 3:7
func_attempt(x, func = function(x){mean(x>3)})
func_attempt(x, func = function(y){ sum(y)/var(y) })
var(1:5)
func_attempt <- function(x, t, func){
return(sapply(x, func))
}
t = 3
rm(t)
set_t = 3
func_attempt(x, func = function(y,t){ mean(y>t) })
?plot
func_attempt <- function(x, t, func, ...){
return(sapply(x, func, ...))
}
func_attempt(x, func = function(y,t){ mean(y>t) }, t = 3)
func_attempt(x, func = function(y,t){ mean(y>t) }, 3)
sapply(x, func = function(y,t){ mean(y>t) }, 3)
sapply(x, func = function(y,t){ mean(y>t) }, t = 3)
sapply(x, function(y,t){ mean(y>t) }, t = 3)
func_attempt <- function(x, func, ...){
return(sapply(x, func, ...))
}
func_attempt(x, func = function(y,t){ mean(y>t) }, 3)
library(roxygen2)
load_all()
library(devtools)
load_all()
bayesgcomp()
typeof(post_draws)
class(post_draws)
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ sex,
A = 'sex', model = "AR1", num_partitions = 100,
warmup = 1000, post_iter = 100 )
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ sex,
A = 'sex', model = "AR1", num_partitions = 100,
warmup = 1000, post_iter = 100 )
rm(bayeshaz)
load_all()
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ sex,
A = 'sex', model = "AR1", num_partitions = 100,
warmup = 1000, post_iter = 100 )
library(survival)
library(cmdstanr)
library(eha)
library(causalBETA)
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ sex,
A = 'sex', model = "AR1", num_partitions = 100,
warmup = 1000, post_iter = 100 )
rebuild_cmdstan()
d = survival::cancer
d = d[complete.cases(d),] ## drop missing data
d$id = 1:nrow(d) ## patient id
d$status[d$status==1] = 0
d$status[d$status==2] = 1
## recode binary variables to 0/1
d$sex[d$sex==2] = 0
d$age = ( d$age - mean(d$age) )/ sd(d$age) ## standardize age
#### ----------- run Bayesian piecewise constant hazard model ------------- ####
post_draws = bayeshaz(d = d,
reg_formula = Surv(time, status) ~ sex,
A = 'sex', model = "AR1", num_partitions = 100,
warmup = 1000, post_iter = 100 )
df_veteran <- survival::veteran
df_veteran <- model.matrix(~., data = df_veteran)
df_veteran <- as.data.frame(df_veteran[, -1])
df_veteran$trt <- ifelse(df_veteran$trt == 2, 1, 0)
df_veteran$prior <- ifelse(df_veteran$prior == 10, 1, 0)
post_draws_unadjust <- bayeshaz(d = df_veteran, ## data set
reg_formula = Surv(time, status) ~ trt,
A = 'trt', ## which variable is treatment
model = "AR1",
sigma = 3,
warmup = 1000,
post_iter = 1000)
ATE_est <- bayesgcomp(post_draws_unadjust, ref = 0, t = c(200,400,600,800),
V = 10)
plot(ATE_est, mode=1)
plot(ATE_est, mode=1, ylim = c(0, 0.3))
plot(ATE_est, mode=1, ylim = c(0, 0.5))
x[,1] <- 1:5
View(post_draws_unadjust)
load_all()
roxygenise()
load_all()
# use the wrapper function
object_list <- bayespipeline(d = df_veteran, ## data set
reg_formula = Surv(time, status) ~ trt,
A = 'trt', ## which variable is treatment
model = "AR1",
sigma = 3,
warmup = 1000,
post_iter = 1000,
ref = 0,
t = 200,
V = 10)
plot(ATE_est)
View(post_draws_unadjust)
class(post_draws_unadjust[["beta_draws"]])
library(coda)
beta_chain1 <- mcmc(post_draws_unadjust[["beta_draws"]])
beta_chain1[1:5,]
mean(beta_chain1)
class(beta_chain1)
class(mean(beta_chain1))
class(beta_chain1[1:5,])
beta_chain2 <- mcmc(sample(beta_chain1, 1000))
beta_chains <- mcmc.list(beta_chain1, beta_chain2)
View(beta_chain1)
rownames(beta_chain1) <- "beta"
colnames(beta_chain1) <- "beta"
colnames(beta_chain2) <- "beta"
View(beta_chain2)
beta_chain2 <- mcmc(post_draws_unadjust[["beta_draws"]][sample(1:1000, 1000),])
colnames(beta_chain2) <- "beta"
beta_chains <- mcmc.list(beta_chain1, beta_chain2)
View(beta_chains)
mean(beta_chains)
summary(beta_chains)
View(unlist(beta_chains))
haz_chain1 <- mcmc(post_draws_unadjust[["haz_draws"]][sample(1:1000, 1000),])
haz_chain2 <- mcmc(post_draws_unadjust[["haz_draws"]][sample(1:1000, 1000),])
View(haz_chain1)
haz_chain3 <- mcmc(post_draws_unadjust[["haz_draws"]][sample(1:1000, 1000),])
haz_chains <- mcmc.list(haz_chain1, haz_chain2)
View(unlist(haz_chains))
beta_chains
dim(beta_chains)
dim(beta_chains[[1]])
dim(beta_chains[[2]])
x
unlist(x)
sapply(x, function(y){y})
View(sapply(beta_chains, function(y){y}))
View(sapply(haz_chains, function(y){y}))
View(do.call(rbind, haz_chains))
View(do.call(rbind, beta_chains))
View(mcmc.list(haz_chains, haz_chain3))
View(do.call(mcmc.list, list(haz_chain1, haz_chain2, haz_chain3)))
View(beta_chains)
summary(beta_chains)
plot(beta_chains)
plot(seq(0.01,2.01,by=0.01), (seq(0.01,2.01,by=0.01) - log(seq(0.01,2.01,by=0.01))), pch = 19, cex = 0.5 )
